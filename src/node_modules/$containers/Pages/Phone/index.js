import React, { Component } from 'react';
import { connect } from 'react-redux';

import Loading from '$components/Loading';
import PhoneCard from './phoneCard';

import style from './PhonePage.module.css';
import { fetchPhoneById } from '$actions/phonePageActions';
import { addProductToBasket } from '$actions/basketActions';
import { setNavPanelItemsState, openModal, pushNavPanelItemsState, popNavPanelItemsState, pushMessage } from '$actions/layoutActions';

class Phone extends Component {

  componentDidMount = () => {

    this.props.fetchPhoneById(this.props.match.params.id);

    let navPanelItems = [
      { type: 'cart' }
    ];
    this.props.setNavPanelItemsState(navPanelItems);
    
  }

  componentDidUpdate = () => {
    let { fetching, item } = this.props;
    if (!fetching && item) {
      let navPanelItems = [
        { type: 'cart' },
        { type: 'text', text: `$${item.price}` }
      ];
      this.props.setNavPanelItemsState(navPanelItems);
    }
  }

  renderPhone = () => {
    let { fetching, item } = this.props;
    if (fetching) return <div className={style.loading}><Loading/></div>
    return (
      <PhoneCard 
        toCart={() => {
          this.props.addProductToBasket(item);
          this.props.pushMessage(`${item.name} added to cart`);
        }}
        {...item}
      />
    );
  }

  render() {
    return (
      this.renderPhone()
    );
  }
}

const mapStateToProps = state => {
  return { ...state.phonePage }
}

const mapDispatchToProps = {
  fetchPhoneById,
  setNavPanelItemsState, pushNavPanelItemsState, popNavPanelItemsState,
  openModal,
  pushMessage,
  addProductToBasket
};

export default connect(mapStateToProps, mapDispatchToProps)(Phone);